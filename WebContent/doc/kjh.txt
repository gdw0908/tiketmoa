
SELECT
COM_SEQ, 
NVL(SUM(CASE WHEN PAYTYP = 'card' THEN MONEY END), 0) CARD,
NVL(SUM(CASE WHEN PAYTYP = 'iche' THEN MONEY END), 0)  ICHE, 
NVL(SUM(CASE WHEN PAYTYP = 'virtual' THEN MONEY END), 0)  VIRTUAL, 
NVL(SUM(CASE WHEN PAYTYP = 'hp' THEN MONEY END), 0)  HP,
NVL(SUM(CASE WHEN PAYTYP = 'card' THEN PG_COMMISSION END), 0) PG_COMMISSION_CARD,
NVL(SUM(CASE WHEN PAYTYP = 'iche' THEN PG_COMMISSION END), 0)  PG_COMMISSION_ICHE, 
NVL(SUM(CASE WHEN PAYTYP = 'virtual' THEN PG_COMMISSION END), 0)  PG_COMMISSION_VIRTUAL, 
NVL(SUM(CASE WHEN PAYTYP = 'hp' THEN PG_COMMISSION END), 0)  PG_COMMISSION_HP,
NVL(SUM(CASE WHEN U_TYPE = 'U' THEN M_COMMISSION END), 0)  M_COMMISSION_U,
NVL(SUM(CASE WHEN U_TYPE = 'C' THEN M_COMMISSION END), 0)  M_COMMISSION_C,
SUM(MONEY) TOTAL 
FROM
(
SELECT
ORDERNO, MAX(COM_SEQ) COM_SEQ, MAX(PAYTYP) PAYTYP, MAX(U_TYPE) U_TYPE, 
SUM(MONEY) MONEY, MAX(PG_COMMISSION) PG_COMMISSION, SUM(M_COMMISSION) M_COMMISSION
FROM
(
SELECT 
E.COM_SEQ, B.PAYTYP, 
DECODE(D.MEMBER_ID, NULL, 'U', 'C') AS U_TYPE,
CASE 
WHEN COD_YN = 'Y' THEN AMT + FEE_AMT
ELSE AMT END MONEY, B.PG_COMMISSION, M_COMMISSION, A.ORDERNO
FROM NSH_CART A 
JOIN NSH_ORDERMST B ON A.ORDERNO = B.ORDERNO
LEFT OUTER JOIN MC_MEMBER C ON A.USER_ID = C.MEMBER_ID
LEFT OUTER JOIN NSH_COOPERATION_MEMBER D ON A.USER_ID = D.MEMBER_ID
JOIN NSH_GOODS E ON A.ITEM_SEQ = E.ITEM_SEQ
JOIN NSH_COOPERATION F ON E.COM_SEQ = F.SEQ AND F.DEL_YN = 'N'
WHERE A.STATUS >= 1 
AND TO_CHAR(B.ORDERDATE,'yyyy-mm-dd') = TO_CHAR(SYSDATE-1,'yyyy-mm-dd')
)
GROUP BY ORDERNO
)
GROUP BY COM_SEQ





환불
SELECT
COM_SEQ, 
NVL(SUM(CASE WHEN PAYTYP = 'card' THEN MONEY END), 0) CARD,
NVL(SUM(CASE WHEN PAYTYP = 'iche' THEN MONEY END), 0)  ICHE, 
NVL(SUM(CASE WHEN PAYTYP = 'virtual' THEN MONEY END), 0)  VIRTUAL, 
NVL(SUM(CASE WHEN PAYTYP = 'hp' THEN MONEY END), 0)  HP,
NVL(SUM(CASE WHEN PAYTYP = 'card' THEN PG_COMMISSION END), 0) PG_COMMISSION_CARD,
NVL(SUM(CASE WHEN PAYTYP = 'iche' THEN PG_COMMISSION END), 0)  PG_COMMISSION_ICHE, 
NVL(SUM(CASE WHEN PAYTYP = 'virtual' THEN PG_COMMISSION END), 0)  PG_COMMISSION_VIRTUAL, 
NVL(SUM(CASE WHEN PAYTYP = 'hp' THEN PG_COMMISSION END), 0)  PG_COMMISSION_HP,
NVL(SUM(CASE WHEN U_TYPE = 'U' THEN M_COMMISSION END), 0)  M_COMMISSION_U,
NVL(SUM(CASE WHEN U_TYPE = 'C' THEN M_COMMISSION END), 0)  M_COMMISSION_C,
SUM(MONEY) TOTAL 
FROM
(
SELECT
ORDERNO, MAX(COM_SEQ) COM_SEQ, MAX(PAYTYP) PAYTYP, MAX(U_TYPE) U_TYPE, 
SUM(MONEY) MONEY, MAX(PG_COMMISSION) PG_COMMISSION, SUM(M_COMMISSION) M_COMMISSION
FROM
(
SELECT 
E.COM_SEQ, B.PAYTYP, 
DECODE(D.MEMBER_ID, NULL, 'U', 'C') AS U_TYPE,
CASE 
WHEN COD_YN = 'Y' THEN AMT + FEE_AMT
ELSE AMT END MONEY, B.PG_COMMISSION, M_COMMISSION, A.ORDERNO
FROM NSH_CART A 
JOIN NSH_ORDERMST B ON A.ORDERNO = B.ORDERNO
LEFT OUTER JOIN MC_MEMBER C ON A.USER_ID = C.MEMBER_ID
LEFT OUTER JOIN NSH_COOPERATION_MEMBER D ON A.USER_ID = D.MEMBER_ID
JOIN NSH_GOODS E ON A.ITEM_SEQ = E.ITEM_SEQ
JOIN NSH_COOPERATION F ON E.COM_SEQ = F.SEQ AND F.DEL_YN = 'N'
WHERE A.STATUS = 22 
AND TO_CHAR(A.HAN_C_DT,'yyyy-mm-dd') = TO_CHAR(SYSDATE-1,'yyyy-mm-dd')
)
GROUP BY ORDERNO
)
GROUP BY COM_SEQ




취소
SELECT
COM_SEQ, 
NVL(SUM(CASE WHEN PAYTYP = 'card' THEN MONEY END), 0) CARD,
NVL(SUM(CASE WHEN PAYTYP = 'iche' THEN MONEY END), 0)  ICHE, 
NVL(SUM(CASE WHEN PAYTYP = 'virtual' THEN MONEY END), 0)  VIRTUAL, 
NVL(SUM(CASE WHEN PAYTYP = 'hp' THEN MONEY END), 0)  HP,
NVL(SUM(CASE WHEN PAYTYP = 'card' THEN PG_COMMISSION END), 0) PG_COMMISSION_CARD,
NVL(SUM(CASE WHEN PAYTYP = 'iche' THEN PG_COMMISSION END), 0)  PG_COMMISSION_ICHE, 
NVL(SUM(CASE WHEN PAYTYP = 'virtual' THEN PG_COMMISSION END), 0)  PG_COMMISSION_VIRTUAL, 
NVL(SUM(CASE WHEN PAYTYP = 'hp' THEN PG_COMMISSION END), 0)  PG_COMMISSION_HP,
NVL(SUM(CASE WHEN U_TYPE = 'U' THEN M_COMMISSION END), 0)  M_COMMISSION_U,
NVL(SUM(CASE WHEN U_TYPE = 'C' THEN M_COMMISSION END), 0)  M_COMMISSION_C,
SUM(MONEY) TOTAL 
FROM
(
SELECT
ORDERNO, MAX(COM_SEQ) COM_SEQ, MAX(PAYTYP) PAYTYP, MAX(U_TYPE) U_TYPE, 
SUM(MONEY) MONEY, MAX(PG_COMMISSION) PG_COMMISSION, SUM(M_COMMISSION) M_COMMISSION
FROM
(
SELECT 
E.COM_SEQ, B.PAYTYP, 
DECODE(D.MEMBER_ID, NULL, 'U', 'C') AS U_TYPE,
CASE 
WHEN COD_YN = 'Y' THEN AMT + FEE_AMT
ELSE AMT END MONEY, B.PG_COMMISSION, M_COMMISSION, A.ORDERNO
FROM NSH_CART A 
JOIN NSH_ORDERMST B ON A.ORDERNO = B.ORDERNO
LEFT OUTER JOIN MC_MEMBER C ON A.USER_ID = C.MEMBER_ID
LEFT OUTER JOIN NSH_COOPERATION_MEMBER D ON A.USER_ID = D.MEMBER_ID
JOIN NSH_GOODS E ON A.ITEM_SEQ = E.ITEM_SEQ
JOIN NSH_COOPERATION F ON E.COM_SEQ = F.SEQ AND F.DEL_YN = 'N'
WHERE A.STATUS = 5 
AND TO_CHAR(A.PAY_E_DT,'yyyy-mm-dd') = TO_CHAR(SYSDATE-1,'yyyy-mm-dd')
)
GROUP BY ORDERNO
)
GROUP BY COM_SEQ

