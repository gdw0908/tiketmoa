<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="event">
	<!-- 이벤트 리스트 -->
	<select id="list" parameterType="Map" resultType="mcmap" >
	<![CDATA[
		SELECT PT1.* FROM (
		SELECT 
			ROW_NUMBER() OVER(ORDER BY T1.SEQ DESC) RN,
			T1.SEQ, T1.TITLE, 
			TO_CHAR(T1.REG_DT,'YYYY-MM-DD') AS REG_DT,
			TO_CHAR(T1.SDATE,'YYYY-MM-DD') AS SDATE,
			TO_CHAR(T1.EDATE,'YYYY-MM-DD') AS EDATE, 
			CASE
				WHEN SDATE <= SYSDATE AND EDATE > SYSDATE-1 THEN '진행중'
				WHEN SDATE > SYSDATE AND EDATE > SYSDATE-1 THEN '진행전'
				ELSE '종료'
			END STATUS,
			EVENT_TYPE,
      		(SELECT COUNT(ITEM_SEQ) FROM NSH_EVENT_ITEM WHERE EVENT_SEQ = T1.SEQ GROUP BY EVENT_SEQ) AS ICNT
		FROM NSH_EVENT T1
		WHERE T1.DEL_YN='N'
	]]>
		<if test="!(keyword == null or keyword == '')" >
        AND T1.TITLE like '%${keyword}%' 
        </if>
		) PT1
		WHERE CEIL(RN/NVL(#{rows, jdbcType=INTEGER},10))=NVL(#{cpage, jdbcType=INTEGER},1)  ORDER BY RN ASC
	</select>
	
	<!-- 이벤트 리스트 페이징 -->
	<select id="pageinfo" parameterType="Map" resultType="mcmap" >
	<![CDATA[
		SELECT 
		CEIL(COUNT(1)/NVL(#{rows, jdbcType=INTEGER},10)) TOTALPAGE,
		COUNT(1) TOTALCOUNT
		FROM NSH_EVENT T1
		WHERE T1.DEL_YN='N'
	]]>
		<if test="!(keyword == null or keyword == '')" >
        AND T1.TITLE like '%${keyword}%' 
        </if>
	</select>
	
	<!-- 이벤트 등록 -->
	<insert id="insert_event" parameterType="Map" useGeneratedKeys="true" keyColumn="seq" keyProperty="event_seq">
		INSERT INTO NSH_EVENT(
			SEQ,
			TITLE,
			SDATE,
			EDATE,
			CONTS,
			REG_SEQ,
			REG_NM,
			EVENT_TYPE
		)VALUES(
			SEQ_NSH_EVENT.nextval,
			#{title},
			TO_DATE(#{sdate}, 'YYYY-MM-DD'),
			TO_DATE(#{edate}, 'YYYY-MM-DD'),
			#{conts},
			#{session_member_seq},
			#{session_member_nm},
			#{event_type}
		)
	</insert>
	
	<!-- 이벤트 수정 -->
	<update id="modify_event" parameterType="Map">
		UPDATE NSH_EVENT SET
			TITLE = #{title},
			SDATE = TO_DATE(#{sdate}, 'YYYY-MM-DD'),
			EDATE = TO_DATE(#{edate}, 'YYYY-MM-DD'),
			CONTS = #{conts},
			MOD_DT = SYSDATE,
			MOD_SEQ = #{session_member_seq},
			MOD_NM = #{session_member_nm},
			EVENT_TYPE = #{event_type}
		WHERE SEQ = ${seq}
	</update>
	
	<!-- 이벤트 삭제 -->
	<update id="delete_event" parameterType="Map">
		UPDATE NSH_EVENT SET
			DEL_YN = 'Y',
			DEL_DT = SYSDATE,
			DEL_SEQ = #{session_member_seq},
			DEL_NM = #{session_member_nm}
		WHERE SEQ = ${seq}
	</update>
	
	
	<!-- 이벤트 아이템 등록 -->
	<insert id="insert_select_item" parameterType="Map">
		INSERT INTO NSH_EVENT_ITEM (
			SEQ,
			EVENT_SEQ,
			ITEM_SEQ,
			COM_SEQ
		) SELECT 
			SEQ_NSH_EVENT_ITEM.nextval,
			${event_seq},
			ITEM_SEQ,
			COM_SEQ
		FROM NSH_GOODS WHERE ITEM_SEQ IN (${event_item_seq})
	</insert>
	
	<!-- 이벤트 아이템 삭제 -->
	<insert id="delete_item" parameterType="Map">
		DELETE FROM NSH_EVENT_ITEM WHERE EVENT_SEQ = ${seq}
	</insert>
	
	
	<!-- 이벤트 참여 아이템 선택 Where -->
	<sql id="listWhere">
		WHERE a.DEL_YN='N'
		<if test='tab == "7"'><!-- 배터리 타이어 전장품 -->
			AND (
				(a.PART1 = '050901004' AND a.PART2 = '050901004012') or (a.PART1 = '050901003' AND a.PART2 = '050901003003') or a.PART1 = '050901006'
			)
		</if>
		<choose>
		<when test="(gubun == null or gubun == '')">
			AND a.GUBUN = '1'
		</when>
		<otherwise>
			AND a.GUBUN = #{gubun}
		</otherwise>
		</choose>
		<if test="!(item_seq == null or item_seq == '')">
			AND a.ITEM_SEQ NOT IN (${item_seq})
		</if>
        <if test='client_yn == "Y"' ><!-- 사용자 페이지에서는 재고 없으면 안보여줌 -->
			AND a.STOCK_NUM > 0
			AND a.APPROVAL = 'Y'
			AND b.UUID IS NOT NULL
			AND DECODE(a.INQUIRY_YN, 'Y', 1, nvl(a.USER_PRICE, 0)) > 0
        </if>
        <if test="!(keyword == null or keyword == '')" >
        	AND (INSTR(lower(a.PRODUCTNM),lower(#{keyword})) > 0 
        	OR INSTR(lower(${condition}),lower(#{keyword})) > 0 
        	OR INSTR(lower(d.MAKERNM),lower(#{keyword})) > 0
        	OR INSTR(lower(f.CARMODELNM),lower(#{keyword})) > 0)
        	OR INSTR(lower(f.CARMODELALIAS),lower(#{keyword})) > 0)
        </if>        
        <if test="!(nation == null or nation == '')" >
        	AND d.NATION = #{nation} 
        </if>
        <if test="!(carmakerseq == null or carmakerseq == '')" >
        	AND a.CARMAKERSEQ = #{carmakerseq} 
        </if>
        <if test="!(carmodelseq == null or carmodelseq == '')" >
        	AND a.CARMODELSEQ = #{carmodelseq} 
        </if>
        <if test="!(cargradeseq == null or cargradeseq == '')" >
        	AND a.CARGRADESEQ = #{cargradeseq} 
        </if>
        <if test="!(caryyyy == null or caryyyy == '')" >
        	AND a.CARYYYY = #{caryyyy} 
        </if>
        <if test="!(color == null or color == '')" >
        	AND a.COLOR = #{color} 
        </if>
        <if test="!(grade == null or grade == '')" >
        	AND a.GRADE = #{grade} 
        </if>
        <if test="!(com_seq == null or com_seq == '' or com_seq == 0)" >
        	AND a.COM_SEQ = #{com_seq} 
        </if>
        <if test="!(part1 == null or part1 == '')" >
        	AND a.PART1 = #{part1} 
        </if>
        <if test="!(part2 == null or part2 == '')" >
        	AND a.PART2 = #{part2} 
        </if>
         <if test="!(part2_1 == null or part2_1 == '')" >
        	AND a.PART2 in #{part2_1} 
        </if>
        <if test="!(part3 == null or part3 == '')" >
        	AND a.PART3 = #{part3} 
        </if>
        <if test="!(item_code == null or item_code == '')" >
        	AND a.ITEM_CODE = #{item_code} 
        </if>
        <if test="!(erp_code == null or erp_code == '')" >
        	AND a.ERP_CODE = #{erp_code} 
        </if>
        <if test="!(approval_yn == null or approval_yn == '')" >
        	AND a.APPROVAL = #{approval_yn} 
        </if>
        <choose>
        	<when test='picture_yn=="Y"'>
        		AND b.UUID IS NOT NULL
        	</when>
        	<when test='picture_yn=="N"'>
        		AND b.UUID IS NULL
        	</when>
        </choose>
        <choose>
        	<when test='stock_yn=="Y"'>
        		AND a.STOCK_NUM > 0
        	</when>
        	<when test='stock_yn=="N"'>
        		AND a.STOCK_NUM = 0
        	</when>
        </choose>
        <choose>
        	<when test='acount_yn=="Y"'>
        		AND nvl(a.USER_PRICE, 0) > 0
        	</when>
        	<when test='acount_yn=="N"'>
        		AND nvl(a.USER_PRICE, 0) = 0
        	</when>
        </choose>
        <if test="search_all_text_arr != null and search_all_text_arr != ''">
			<foreach index="index" collection="search_all_text_arr">
				AND (
				a.SEARCH_TAG LIKE '%${search_all_text_arr[index]}%'
				OR d.MAKERNM LIKE '%${search_all_text_arr[index]}%'
				OR f.CARMODELNM LIKE '%${search_all_text_arr[index]}%'
				OR f.CARMODELALIAS LIKE '%${search_all_text_arr[index]}%'
				OR a.ITEM_CODE = '${search_all_text_arr[index]}'
        		<if test="!(search_all_text == null or search_all_text == '')" >
				OR e.PARTNM LIKE '%${search_all_text_arr[index]}%'
				OR X.CODENM LIKE '%${search_all_text_arr[index]}%'
				</if>
				)
			</foreach>
	 	</if>
        <if test="sdate != null and sdate != '' and edate != null and edate != ''" >
        	AND a.REG_DT BETWEEN TO_DATE(#{sdate} || '000000', 'YYYY-MM-DDHH24MISS') AND TO_DATE(#{edate} || '235959', 'YYYY-MM-DDHH24MISS')
        </if>
        <if test="!(session_member_id == null or session_member_id == '')" >
			AND	a.REG_ID = #{session_member_id}
		</if>
	</sql>
	
	
	<select id="item_select" parameterType="Map" resultType="mcmap">
		SELECT PT1.*, IS_LOCATION(CARPARTCODE) AS PART_LOCATION FROM (
			SELECT 
				PT_SUB.*,
                (SELECT CARGRADENM FROM V_IS_CARGRADE WHERE PT_SUB.CARGRADESEQ=CARGRADESEQ) AS CARGRADENM,
                (SELECT CODENM FROM V_IS_CODEMST WHERE PT_SUB.PART1=CODENO) AS PART1_NM,
                (SELECT CODENM FROM V_IS_CODEMST WHERE PT_SUB.PART2=CODENO) AS PART2_NM,
                (SELECT PARTNM FROM V_IS_CARPART WHERE PT_SUB.PART3=CARPARTSEQ) AS PART3_NM,
                (SELECT CODE_NM FROM MC_COMMON_CODE WHERE CODE_GROUP_SEQ = '37' AND PT_SUB.COLOR=CODE) AS COLOR_NM,
                (SELECT DONG_NM FROM NSH_DONG WHERE PT_SUB.SIDO_CD=SIDO AND PT_SUB.SIGUNGU_CD=SIGUNGU AND DONG='000') as SIGUNGU_NM,
                ('/upload/board/'||PT_SUB.YYYY||'/'||PT_SUB.MM||'/'||PT_SUB.UUID) AS THUMB,
				<choose>
            		<when test="(sort == 'row')">
	                ROW_NUMBER() OVER(ORDER BY PT_SUB.USER_PRICE ASC) RN
            		</when>
            		<when test="(sort == 'high')">
	                ROW_NUMBER() OVER(ORDER BY PT_SUB.USER_PRICE DESC) RN
            		</when>
            		<otherwise>
                	ROW_NUMBER() OVER(ORDER BY PT_SUB.ITEM_SEQ DESC) RN
            		</otherwise>
            	</choose>
			FROM(
            SELECT
                a.ITEM_SEQ, a.ITEM_CODE, a.COM_SEQ, a.ERP_CODE, a.PRODUCTNM,a.CARYYYY, a.GRADE, a.USER_PRICE, a.SUPPLIER_PRICE, a.SALE_PRICE, a.INQUIRY_YN,
                a.FEE_YN, a.BESTYN, a.EVENTYN, a.NEWYN, a.PUBLICYN, a.RECOMMYN, a.SALEYN, a.PLANYN, a.STOCK_NUM,
                a.CARMAKERSEQ, a.CARMODELSEQ, a.CARGRADESEQ, a.PART1, a.PART2, a.PART3, a.COLOR,
                a.REG_DT,a.DISCOUNT_RATE, a.CARPARTCODE, 
                d.MAKERNM, f.CARMODELNM,
                DECODE(a.APPROVAL, 'Y', '승인', '비승인') as APPROVAL,
                b.ATTACH_NM,
                c.COM_NM, c.STAFF_TEL, c.SIDO_CD, c.SIGUNGU_CD,
                b.YYYY, b.MM, b.UUID
            FROM NSH_GOODS a LEFT OUTER JOIN NSH_ATTACH b
            ON b.TABLE_NM='NSH_GOODS' AND a.ITEM_SEQ = b.TABLE_SEQ AND b.ORDER_SEQ=1
            LEFT OUTER JOIN NSH_COOPERATION c
            ON a.COM_SEQ = c.SEQ
            LEFT OUTER JOIN V_IS_CARMAKER d ON a.CARMAKERSEQ=d.CARMAKERSEQ
            LEFT OUTER JOIN V_IS_CARMODEL f ON a.CARMODELSEQ=f.CARMODELSEQ
        	<if test="!(search_all_text == null or search_all_text == '')" >
        	LEFT OUTER JOIN V_IS_CODEMST X ON a.PART2=X.CODENO
            LEFT OUTER JOIN V_IS_CARPART e ON a.PART3=e.CARPARTSEQ            
            </if>
			<include refid="listWhere"/>
			) PT_SUB
		) PT1
		WHERE RN BETWEEN NVL(#{rows, jdbcType=INTEGER},10) * (NVL(#{cpage, jdbcType=INTEGER},1) - 1) + 1 AND NVL(#{rows, jdbcType=INTEGER},10) * NVL(#{cpage, jdbcType=INTEGER},1)
	</select>
	
	
	<select id="item_select_pageinfo" parameterType="Map" resultType="mcmap">
		SELECT
			CEIL(COUNT(1)/NVL(#{rows}, 10)) TOTALPAGE,
			COUNT(1) TOTALCOUNT
        FROM NSH_GOODS a LEFT OUTER JOIN NSH_ATTACH b
            ON b.TABLE_NM='NSH_GOODS' AND a.ITEM_SEQ = b.TABLE_SEQ AND b.ORDER_SEQ=1
            LEFT OUTER JOIN NSH_COOPERATION c
            ON a.COM_SEQ= c.SEQ
            LEFT OUTER JOIN V_IS_CARMAKER d ON a.CARMAKERSEQ=d.CARMAKERSEQ
            LEFT OUTER JOIN V_IS_CARMODEL f ON a.CARMODELSEQ=f.CARMODELSEQ
            <if test="!(search_all_text == null or search_all_text == '')" >
        	LEFT OUTER JOIN V_IS_CODEMST X ON a.PART2=X.CODENO
            LEFT OUTER JOIN V_IS_CARPART e ON a.PART3=e.CARPARTSEQ            
            </if>
		<include refid="listWhere"/>
	</select>
	
	
	<select id="item_select_list" parameterType="Map" resultType="mcmap">
		SELECT PT1.*, IS_LOCATION(CARPARTCODE) AS PART_LOCATION FROM (
			SELECT 
				PT_SUB.*,
                (SELECT CARGRADENM FROM V_IS_CARGRADE WHERE PT_SUB.CARGRADESEQ=CARGRADESEQ) AS CARGRADENM,
                (SELECT CODENM FROM V_IS_CODEMST WHERE PT_SUB.PART1=CODENO) AS PART1_NM,
                (SELECT CODENM FROM V_IS_CODEMST WHERE PT_SUB.PART2=CODENO) AS PART2_NM,
                (SELECT PARTNM FROM V_IS_CARPART WHERE PT_SUB.PART3=CARPARTSEQ) AS PART3_NM,
                (SELECT CODE_NM FROM MC_COMMON_CODE WHERE CODE_GROUP_SEQ = '37' AND PT_SUB.COLOR=CODE) AS COLOR_NM,
                (SELECT DONG_NM FROM NSH_DONG WHERE PT_SUB.SIDO_CD=SIDO AND PT_SUB.SIGUNGU_CD=SIGUNGU AND DONG='000') as SIGUNGU_NM,
                ('/upload/board/'||PT_SUB.YYYY||'/'||PT_SUB.MM||'/'||PT_SUB.UUID) AS THUMB,
               	ROW_NUMBER() OVER(ORDER BY PT_SUB.ITEM_SEQ DESC) RN
			FROM(
            SELECT
                a.ITEM_SEQ, a.ITEM_CODE, a.COM_SEQ, a.ERP_CODE, a.PRODUCTNM,a.CARYYYY, a.GRADE, a.USER_PRICE, a.SUPPLIER_PRICE, a.SALE_PRICE, a.INQUIRY_YN,
                a.FEE_YN, a.BESTYN, a.EVENTYN, a.NEWYN, a.PUBLICYN, a.RECOMMYN, a.SALEYN, a.PLANYN, a.STOCK_NUM,
                a.CARMAKERSEQ, a.CARMODELSEQ, a.CARGRADESEQ, a.PART1, a.PART2, a.PART3, a.COLOR,
                a.REG_DT,a.DISCOUNT_RATE, a.CARPARTCODE, 
                d.MAKERNM, f.CARMODELNM,
                DECODE(a.APPROVAL, 'Y', '승인', '비승인') as APPROVAL,
                b.ATTACH_NM,
                c.COM_NM, c.STAFF_TEL, c.SIDO_CD, c.SIGUNGU_CD,
                b.YYYY, b.MM, b.UUID
            FROM NSH_GOODS a LEFT OUTER JOIN NSH_ATTACH b
            ON b.TABLE_NM='NSH_GOODS' AND a.ITEM_SEQ = b.TABLE_SEQ AND b.ORDER_SEQ=1
            LEFT OUTER JOIN NSH_COOPERATION c
            ON a.COM_SEQ = c.SEQ
            LEFT OUTER JOIN V_IS_CARMAKER d ON a.CARMAKERSEQ=d.CARMAKERSEQ
            LEFT OUTER JOIN V_IS_CARMODEL f ON a.CARMODELSEQ=f.CARMODELSEQ
            WHERE 
            	a.ITEM_SEQ IN (${item_seq})
			) PT_SUB
		) PT1
	</select>
	
	
	<!-- 이벤트 뷰 -->
	<select id="view" parameterType="Map" resultType="mcmap" >
	<![CDATA[
		SELECT 
			T1.SEQ,
			T1.TITLE, 
			TO_CHAR(T1.SDATE,'YYYY-MM-DD') AS SDATE,
			TO_CHAR(T1.EDATE,'YYYY-MM-DD') AS EDATE, 
			CASE
				WHEN SDATE <= SYSDATE AND EDATE > SYSDATE-1 THEN '진행중'
				WHEN SDATE > SYSDATE AND EDATE > SYSDATE-1 THEN '대기'
				ELSE '종료'
			END STATUS,
			CASE
				WHEN SDATE <= SYSDATE AND EDATE > SYSDATE-1 THEN '1'
				WHEN SDATE > SYSDATE AND EDATE > SYSDATE-1 THEN '3'
				ELSE '2'
			END STATUS_CODE,
			EVENT_TYPE,
      		(SELECT COUNT(ITEM_SEQ) FROM NSH_EVENT_ITEM WHERE EVENT_SEQ = T1.SEQ GROUP BY EVENT_SEQ) AS ICNT,
      		CONTS
		FROM NSH_EVENT T1
	]]>
		WHERE T1.DEL_YN='N' AND T1.SEQ = ${seq}
	</select>
	
	
	
	
	
	
	
	<!-- 이벤트 아이템 -->
	<sql id="listWhere2">
		WHERE 
           	T1.EVENT_SEQ = ${seq}
			AND a.DEL_YN='N'
		<if test='tab == "7"'><!-- 배터리 타이어 전장품 -->
			AND (
				(a.PART1 = '050901004' AND a.PART2 = '050901004012') or (a.PART1 = '050901003' AND a.PART2 = '050901003003') or a.PART1 = '050901006'
			)
		</if>
		<choose>
		<when test="(gubun == null or gubun == '')">
			AND a.GUBUN = '1'
		</when>
		<otherwise>
			AND a.GUBUN = #{gubun}
		</otherwise>
		</choose>
        <if test='client_yn == "Y"' ><!-- 사용자 페이지에서는 재고 없으면 안보여줌 -->
			AND a.STOCK_NUM > 0
			AND a.APPROVAL = 'Y'
			AND b.UUID IS NOT NULL
			AND DECODE(a.INQUIRY_YN, 'Y', 1, nvl(a.USER_PRICE, 0)) > 0
        </if>
        <if test="!(keyword == null or keyword == '')" >
        	AND (INSTR(lower(a.PRODUCTNM),lower(#{keyword})) > 0 
        	OR INSTR(lower(${condition}),lower(#{keyword})) > 0 
        	OR INSTR(lower(d.MAKERNM),lower(#{keyword})) > 0
        	OR INSTR(lower(f.CARMODELNM),lower(#{keyword})) > 0)
        	OR INSTR(lower(f.CARMODELALIAS),lower(#{keyword})) > 0)
        </if>        
        <if test="!(nation == null or nation == '')" >
        	AND d.NATION = #{nation} 
        </if>
        <if test="!(carmakerseq == null or carmakerseq == '')" >
        	AND a.CARMAKERSEQ = #{carmakerseq} 
        </if>
        <if test="!(carmodelseq == null or carmodelseq == '')" >
        	AND a.CARMODELSEQ = #{carmodelseq} 
        </if>
        <if test="!(cargradeseq == null or cargradeseq == '')" >
        	AND a.CARGRADESEQ = #{cargradeseq} 
        </if>
        <if test="!(caryyyy == null or caryyyy == '')" >
        	AND a.CARYYYY = #{caryyyy} 
        </if>
        <if test="!(color == null or color == '')" >
        	AND a.COLOR = #{color} 
        </if>
        <if test="!(grade == null or grade == '')" >
        	AND a.GRADE = #{grade} 
        </if>
        <if test="!(com_seq == null or com_seq == '' or com_seq == 0)" >
        	AND a.COM_SEQ = #{com_seq} 
        </if>
        <if test="!(part1 == null or part1 == '')" >
        	AND a.PART1 = #{part1} 
        </if>
        <if test="!(part2 == null or part2 == '')" >
        	AND a.PART2 = #{part2} 
        </if>
         <if test="!(part2_1 == null or part2_1 == '')" >
        	AND a.PART2 in #{part2_1} 
        </if>
        <if test="!(part3 == null or part3 == '')" >
        	AND a.PART3 = #{part3} 
        </if>
        <if test="!(item_code == null or item_code == '')" >
        	AND a.ITEM_CODE = #{item_code} 
        </if>
        <if test="!(erp_code == null or erp_code == '')" >
        	AND a.ERP_CODE = #{erp_code} 
        </if>
        <if test="!(approval_yn == null or approval_yn == '')" >
        	AND a.APPROVAL = #{approval_yn} 
        </if>
        <choose>
        	<when test='picture_yn=="Y"'>
        		AND b.UUID IS NOT NULL
        	</when>
        	<when test='picture_yn=="N"'>
        		AND b.UUID IS NULL
        	</when>
        </choose>
        <choose>
        	<when test='stock_yn=="Y"'>
        		AND a.STOCK_NUM > 0
        	</when>
        	<when test='stock_yn=="N"'>
        		AND a.STOCK_NUM = 0
        	</when>
        </choose>
        <choose>
        	<when test='acount_yn=="Y"'>
        		AND nvl(a.USER_PRICE, 0) > 0
        	</when>
        	<when test='acount_yn=="N"'>
        		AND nvl(a.USER_PRICE, 0) = 0
        	</when>
        </choose>
        <if test="search_all_text_arr != null and search_all_text_arr != ''">
			<foreach index="index" collection="search_all_text_arr">
				AND (
				a.SEARCH_TAG LIKE '%${search_all_text_arr[index]}%'
				OR d.MAKERNM LIKE '%${search_all_text_arr[index]}%'
				OR f.CARMODELNM LIKE '%${search_all_text_arr[index]}%'
				OR f.CARMODELALIAS LIKE '%${search_all_text_arr[index]}%'
				OR a.ITEM_CODE = '${search_all_text_arr[index]}'
				OR e.PARTNM LIKE '%${search_all_text_arr[index]}%'
				OR X.CODENM LIKE '%${search_all_text_arr[index]}%'
				)
			</foreach>
	 	</if>
        <if test="sdate != null and sdate != '' and edate != null and edate != ''" >
        	AND a.REG_DT BETWEEN TO_DATE(#{sdate} || '000000', 'YYYY-MM-DDHH24MISS') AND TO_DATE(#{edate} || '235959', 'YYYY-MM-DDHH24MISS')
        </if>
        <if test="!(session_member_id == null or session_member_id == '')" >
			AND	a.REG_ID = #{session_member_id}
		</if>
	</sql>
	
	
	
	
	
	
	
	
	
	<select id="item" parameterType="Map" resultType="mcmap" >
	SELECT PT1.*, IS_LOCATION(CARPARTCODE) AS PART_LOCATION FROM (
			SELECT 
				PT_SUB.*,
                (SELECT CARGRADENM FROM V_IS_CARGRADE WHERE PT_SUB.CARGRADESEQ=CARGRADESEQ) AS CARGRADENM,
                (SELECT CODENM FROM V_IS_CODEMST WHERE PT_SUB.PART1=CODENO) AS PART1_NM,
                (SELECT CODENM FROM V_IS_CODEMST WHERE PT_SUB.PART2=CODENO) AS PART2_NM,
                (SELECT PARTNM FROM V_IS_CARPART WHERE PT_SUB.PART3=CARPARTSEQ) AS PART3_NM,
                (SELECT CODE_NM FROM MC_COMMON_CODE WHERE CODE_GROUP_SEQ = '37' AND PT_SUB.COLOR=CODE) AS COLOR_NM,
                (SELECT DONG_NM FROM NSH_DONG WHERE PT_SUB.SIDO_CD=SIDO AND PT_SUB.SIGUNGU_CD=SIGUNGU AND DONG='000') as SIGUNGU_NM,
                ('/upload/board/'||PT_SUB.YYYY||'/'||PT_SUB.MM||'/'||PT_SUB.UUID) AS THUMB,
               	ROW_NUMBER() OVER(ORDER BY PT_SUB.ITEM_SEQ DESC) RN
			FROM(
            SELECT
                a.ITEM_SEQ, a.ITEM_CODE, a.COM_SEQ, a.ERP_CODE, a.PRODUCTNM,a.CARYYYY, a.GRADE, a.USER_PRICE, a.SUPPLIER_PRICE, a.SALE_PRICE, a.INQUIRY_YN,
                a.FEE_YN, a.BESTYN, a.EVENTYN, a.NEWYN, a.PUBLICYN, a.RECOMMYN, a.SALEYN, a.PLANYN, a.STOCK_NUM,
                a.CARMAKERSEQ, a.CARMODELSEQ, a.CARGRADESEQ, a.PART1, a.PART2, a.PART3, a.COLOR,
                a.REG_DT,
                CASE
                WHEN a.SALE_SDATE &lt;= SYSDATE AND a.SALE_EDATE &gt; SYSDATE-1 THEN a.DISCOUNT_RATE
                ELSE 0
                END AS DISCOUNT_RATE,
                a.CARPARTCODE, 
                d.MAKERNM, f.CARMODELNM,
                DECODE(a.APPROVAL, 'Y', '승인', '비승인') as APPROVAL,
                b.ATTACH_NM,
                c.COM_NM, c.STAFF_TEL, c.SIDO_CD, c.SIGUNGU_CD,
                b.YYYY, b.MM, b.UUID
            FROM 
            NSH_EVENT_ITEM T1
            LEFT OUTER JOIN NSH_GOODS a ON a.ITEM_SEQ = T1.ITEM_SEQ
            LEFT OUTER JOIN NSH_ATTACH b ON b.TABLE_NM='NSH_GOODS' AND a.ITEM_SEQ = b.TABLE_SEQ AND b.ORDER_SEQ=1
            LEFT OUTER JOIN NSH_COOPERATION c ON a.COM_SEQ = c.SEQ
            LEFT OUTER JOIN V_IS_CARMAKER d ON a.CARMAKERSEQ=d.CARMAKERSEQ
            LEFT OUTER JOIN V_IS_CARMODEL f ON a.CARMODELSEQ=f.CARMODELSEQ
            <if test="!(search_all_text_arr == null or search_all_text_arr == '')" >
        	LEFT OUTER JOIN V_IS_CODEMST X ON a.PART2=X.CODENO
            LEFT OUTER JOIN V_IS_CARPART e ON a.PART3=e.CARPARTSEQ            
            </if>
            <include refid="listWhere2"/>
			) PT_SUB
		) PT1
	<if test="!(userYN == null or userYN == '')">
	WHERE RN BETWEEN NVL(#{rows, jdbcType=INTEGER},10) * (NVL(#{cpage, jdbcType=INTEGER},1) - 1) + 1 AND NVL(#{rows, jdbcType=INTEGER},10) * NVL(#{cpage, jdbcType=INTEGER},1)
	</if>
	</select>
	
	
	
	<select id="itemPagination" parameterType="Map" resultType="mcmap" >
	SELECT 
		CEIL(COUNT(1)/NVL(#{rows}, 10)) TOTALPAGE,
		COUNT(1) TOTALCOUNT
	FROM (
			SELECT 
				PT_SUB.*,
                (SELECT CARGRADENM FROM V_IS_CARGRADE WHERE PT_SUB.CARGRADESEQ=CARGRADESEQ) AS CARGRADENM,
                (SELECT CODENM FROM V_IS_CODEMST WHERE PT_SUB.PART1=CODENO) AS PART1_NM,
                (SELECT CODENM FROM V_IS_CODEMST WHERE PT_SUB.PART2=CODENO) AS PART2_NM,
                (SELECT PARTNM FROM V_IS_CARPART WHERE PT_SUB.PART3=CARPARTSEQ) AS PART3_NM,
                (SELECT CODE_NM FROM MC_COMMON_CODE WHERE CODE_GROUP_SEQ = '37' AND PT_SUB.COLOR=CODE) AS COLOR_NM,
                (SELECT DONG_NM FROM NSH_DONG WHERE PT_SUB.SIDO_CD=SIDO AND PT_SUB.SIGUNGU_CD=SIGUNGU AND DONG='000') as SIGUNGU_NM,
                ('/upload/board/'||PT_SUB.YYYY||'/'||PT_SUB.MM||'/'||PT_SUB.UUID) AS THUMB,
               	ROW_NUMBER() OVER(ORDER BY PT_SUB.ITEM_SEQ DESC) RN
			FROM(
            SELECT
                a.ITEM_SEQ, a.ITEM_CODE, a.COM_SEQ, a.ERP_CODE, a.PRODUCTNM,a.CARYYYY, a.GRADE, a.USER_PRICE, a.SUPPLIER_PRICE, a.SALE_PRICE, a.INQUIRY_YN,
                a.FEE_YN, a.BESTYN, a.EVENTYN, a.NEWYN, a.PUBLICYN, a.RECOMMYN, a.SALEYN, a.PLANYN, a.STOCK_NUM,
                a.CARMAKERSEQ, a.CARMODELSEQ, a.CARGRADESEQ, a.PART1, a.PART2, a.PART3, a.COLOR,
                a.REG_DT,
                CASE
                WHEN a.SALE_SDATE &lt;= SYSDATE AND a.SALE_EDATE &gt; SYSDATE-1 THEN a.DISCOUNT_RATE
                ELSE 0
                END AS DISCOUNT_RATE,
                a.CARPARTCODE, 
                d.MAKERNM, f.CARMODELNM,
                DECODE(a.APPROVAL, 'Y', '승인', '비승인') as APPROVAL,
                b.ATTACH_NM,
                c.COM_NM, c.STAFF_TEL, c.SIDO_CD, c.SIGUNGU_CD,
                b.YYYY, b.MM, b.UUID
            FROM 
            NSH_EVENT_ITEM T1
            LEFT OUTER JOIN NSH_GOODS a ON a.ITEM_SEQ = T1.ITEM_SEQ
            LEFT OUTER JOIN NSH_ATTACH b ON b.TABLE_NM='NSH_GOODS' AND a.ITEM_SEQ = b.TABLE_SEQ AND b.ORDER_SEQ=1
            LEFT OUTER JOIN NSH_COOPERATION c ON a.COM_SEQ = c.SEQ
            LEFT OUTER JOIN V_IS_CARMAKER d ON a.CARMAKERSEQ=d.CARMAKERSEQ
            LEFT OUTER JOIN V_IS_CARMODEL f ON a.CARMODELSEQ=f.CARMODELSEQ
            <if test="!(search_all_text_arr == null or search_all_text_arr == '')" >
        	LEFT OUTER JOIN V_IS_CODEMST X ON a.PART2=X.CODENO
            LEFT OUTER JOIN V_IS_CARPART e ON a.PART3=e.CARPARTSEQ            
            </if>
            <include refid="listWhere2"/>
			) PT_SUB
		) PT1
	</select>	
	
</mapper>