<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="seller">

	<sql id="listWhere">
		WHERE a.DEL_YN='N'
			AND COM_SEQ = #{session_member_com_seq}
        	AND a.GUBUN = nvl(#{gubun}, '1')
        <!-- <if test='client_yn == "Y"' > 
			AND a.STOCK_NUM > 0
        </if> --><!-- 사용자 페이지에서는 재고 없으면 안보여줌 -->
        <if test="!(keyword == null or keyword == '')" >
        	AND ${condition} like '%${keyword}%' 
        </if>
        <if test="!(nation == null or nation == '')" >
        	AND d.NATION = #{nation} 
        </if>
        <if test="!(carmakerseq == null or carmakerseq == '')" >
        	AND a.CARMAKERSEQ = #{carmakerseq} 
        </if>
        <if test="!(carmodelseq == null or carmodelseq == '')" >
        	AND a.CARMODELSEQ = #{carmodelseq} 
        </if>
        <if test="!(cargradeseq == null or cargradeseq == '')" >
        	AND a.CARGRADESEQ = #{cargradeseq} 
        </if>
        <if test="!(caryyyy == null or caryyyy == '')" >
        	AND a.CARYYYY = #{caryyyy} 
        </if>
        <if test="!(color == null or color == '')" >
        	AND a.COLOR = #{color} 
        </if>
        <if test="!(grade == null or grade == '')" >
        	AND a.GRADE = #{grade} 
        </if>
        <if test="!(part1 == null or part1 == '')" >
        	AND a.PART1 = #{part1} 
        </if>
        <if test="!(part2 == null or part2 == '')" >
        	<!-- AND a.PART2 = #{part2}  -->
        	AND a.PART2 = #{part2} 
        </if>
         <if test="!(part2_1 == null or part2_1 == '')" >
        	<!-- AND a.PART2 = #{part2}  -->
        	AND a.PART2 in #{part2_1} 
        </if>
        <if test="!(part3 == null or part3 == '')" >
        	AND a.PART3 = #{part3} 
        </if>
        <if test="!(item_code == null or item_code == '')" >
        	AND a.ITEM_CODE = #{item_code} 
        </if>
        <if test="!(erp_code == null or erp_code == '')" >
        	AND a.ERP_CODE = #{erp_code} 
        </if>
        <if test="!(search_all_text == null or search_all_text == '')" >
        	AND a.PRODUCTNM LIKE '%${search_all_text}%'
        	OR a.SEARCH_TAG LIKE '%${search_all_text}%'
        </if>
        <if test="sdate != null and sdate != '' and edate != null and edate != ''" >
        	AND a.REG_DT BETWEEN TO_DATE(#{sdate} || '000000', 'YYYY-MM-DDHH24MISS') AND TO_DATE(#{edate} || '235959', 'YYYY-MM-DDHH24MISS')
        </if>
	</sql>
	
	<select id="seller_list" parameterType="Map" resultType="mcmap">
		SELECT PT1.*, IS_LOCATION(CARPARTCODE) AS PART_LOCATION FROM (
            SELECT
                ROW_NUMBER() OVER(ORDER BY a.ITEM_SEQ DESC) RN,
                a.ITEM_SEQ, a.ITEM_CODE, a.COM_SEQ, a.ERP_CODE, a.PRODUCTNM,a.CARYYYY, a.GRADE, a.USER_PRICE, a.SUPPLIER_PRICE, a.SALE_PRICE, 
                a.FEE_YN, a.BESTYN, a.EVENTYN, a.NEWYN, a.PUBLICYN, a.RECOMMYN, a.SALEYN, a.PLANYN, a.STOCK_NUM,
                a.CARMAKERSEQ, a.CARMODELSEQ, a.CARGRADESEQ, a.PART1, a.PART2, a.PART3, a.COLOR,
                TO_CHAR(a.REG_DT,'YYYY-MM-DD') REG_DATE,
                TO_CHAR(a.MOD_DT,'YYYY-MM-DD') MOD_DATE,
                a.DISCOUNT_RATE, a.CARPARTCODE, 
                d.MAKERNM, f.CARMODELNM,
                (SELECT CARGRADENM FROM V_IS_CARGRADE WHERE a.CARGRADESEQ=CARGRADESEQ) AS CARGRADENM,
                (SELECT CODENM FROM V_IS_CODEMST WHERE a.PART1=CODENO) AS PART1_NM,
                (SELECT CODENM FROM V_IS_CODEMST WHERE a.PART2=CODENO) AS PART2_NM,
                (SELECT PARTNM FROM V_IS_CARPART WHERE a.PART3=CARPARTSEQ) AS PART3_NM,
                (SELECT CODE_NM FROM MC_COMMON_CODE WHERE CODE_GROUP_SEQ = '37' AND a.COLOR=CODE) AS COLOR_NM,
                DECODE(a.APPROVAL, 'Y', '승인', '비승인') as APPROVAL,
                ('/upload/board/'||b.YYYY||'/'||b.MM||'/'||b.UUID||'_thumb') AS THUMB,
                b.ATTACH_NM,
                c.COM_NM, c.STAFF_TEL,
                (SELECT DONG_NM FROM NSH_DONG WHERE c.SIDO_CD=SIDO AND c.SIGUNGU_CD=SIGUNGU AND DONG='000') as SIGUNGU_NM
            FROM NSH_GOODS a LEFT OUTER JOIN (
                SELECT
                    bb.*
                FROM (SELECT max(uuid) as uuid FROM NSH_ATTACH GROUP BY TABLE_NM, TABLE_SEQ) aa LEFT OUTER JOIN NSH_ATTACH bb
                ON aa.UUID = bb.UUID
            ) b
            ON b.TABLE_NM='NSH_GOODS' AND a.ITEM_SEQ = b.TABLE_SEQ
            LEFT OUTER JOIN NSH_COOPERATION c
            ON a.COM_SEQ = c.SEQ
            LEFT OUTER JOIN V_IS_CARMAKER d ON a.CARMAKERSEQ=d.CARMAKERSEQ
            LEFT OUTER JOIN V_IS_CARMODEL f ON a.CARMODELSEQ=f.CARMODELSEQ
			<include refid="listWhere"/>
		) PT1
		WHERE CEIL(RN/NVL(#{rows},10))=NVL(#{cpage},1)
    	<if test="(sort == 'row')" >
    	ORDER BY 
    		SALE_PRICE ASC
    	</if>
    	<if test="(sort == 'high')" >
    	ORDER BY 
    		SALE_PRICE DESC
    	</if>
	</select>
	
	<select id="seller_pagination" parameterType="Map" resultType="mcmap">
		SELECT
			CEIL(COUNT(1)/NVL(#{rows}, 10)) TOTALPAGE,
			COUNT(1) TOTALCOUNT
        FROM NSH_GOODS a LEFT OUTER JOIN (
                SELECT
                    bb.*
                FROM (SELECT max(uuid) as uuid FROM NSH_ATTACH GROUP BY TABLE_NM, TABLE_SEQ) aa LEFT OUTER JOIN NSH_ATTACH bb
                ON aa.UUID = bb.UUID
            ) b
            ON b.TABLE_NM='NSH_GOODS' AND a.ITEM_SEQ = b.TABLE_SEQ
            LEFT OUTER JOIN NSH_COOPERATION c
            ON a.COM_SEQ= c.SEQ
            LEFT OUTER JOIN V_IS_CARMAKER d ON a.CARMAKERSEQ=d.CARMAKERSEQ
            LEFT OUTER JOIN V_IS_CARMODEL f ON a.CARMODELSEQ=f.CARMODELSEQ 
		<include refid="listWhere"/>
	</select>
	
	<select id="seller_Info" parameterType="Map" resultType="mcmap">
		SELECT * FROM NSH_COOPERATION A WHERE A.DEL_YN='N' AND A.SEQ = #{session_member_com_seq}
	</select>
	
	<update id="seller_modify" parameterType="Map">
		update NSH_GOODS set
			CARMAKERSEQ = #{carmakerseq} 
			, CARMODELSEQ = #{carmodelseq} 
			, CARGRADESEQ = #{cargradeseq} 
			, PRODUCTNM = #{productnm} 
			, CARYYYY = #{caryyyy} 
			, COLOR = #{color} 
			, GRADE = #{grade} 
			, PART1 = #{part1} 
			, PART2 = #{part2} 
			, PART3 = #{part3} 
			, USER_PRICING_YN = #{user_pricing_yn} 
			, USER_PRICE = #{user_price} 
			, SUPPLIER_PRICING_YN = #{supplier_pricing_yn} 
			, SUPPLIER_PRICE = #{supplier_price} 
			, SEARCH_TAG = #{search_tag} 
			, CONTS = #{conts}
			, MOD_ID = #{session_member_id}
			, MOD_DT = sysdate
		WHERE ITEM_SEQ = #{item_seq}
	</update>
	
	<select id="seller_view" parameterType="Map" resultType="mcmap">
		SELECT
			a.*,
            b.COM_NM, b.ADDR1, b.ADDR2, b.STAFF_NM, b.STAFF_TEL, b.CEO_NM, b.TEL, b.FAX, b.TELESALES_NO, b.COMPTYP1, b.COMPTYP2, b.BUSI_NO,
            b.X_COORD, b.Y_COORD,
            TO_CHAR(b.REG_DT,'YYYY-MM-DD') REG_DATE,
            (SELECT MAKERNM FROM V_IS_CARMAKER WHERE a.CARMAKERSEQ=CARMAKERSEQ) AS MAKERNM,
            (SELECT CARMODELNM FROM V_IS_CARMODEL WHERE a.CARMODELSEQ=CARMODELSEQ) AS CARMODELNM,
            (SELECT CARGRADENM FROM V_IS_CARGRADE WHERE a.CARGRADESEQ=CARGRADESEQ) AS CARGRADENM,
            (SELECT CODENM FROM V_IS_CODEMST WHERE a.PART1=CODENO) AS PART1_NM,
            (SELECT CODENM FROM V_IS_CODEMST WHERE a.PART2=CODENO) AS PART2_NM,
            (SELECT PARTNM FROM V_IS_CARPART WHERE a.PART3=CARPARTSEQ) AS PART3_NM,
            (SELECT CODE_NM FROM MC_COMMON_CODE WHERE CODE_GROUP_SEQ = '37' AND a.COLOR=CODE) AS COLOR_NM
		FROM NSH_GOODS a LEFT OUTER JOIN NSH_COOPERATION b
        ON a.COM_SEQ = b.SEQ
		WHERE a.ITEM_SEQ = #{seq} AND a.COM_SEQ = ${session_member_com_seq}
	</select>
	
	<update id="seller_del" parameterType="Map">
		UPDATE NSH_GOODS SET
			DEL_YN = 'Y'
			,DEL_ID = #{session_member_id}
			,DEL_DT = sysdate
		WHERE ITEM_SEQ = #{item_seq}
	</update>
	
	
	
	<update id="seller_write" parameterType="Map" useGeneratedKeys="true" keyColumn="item_seq" keyProperty="parent_seq">
		INSERT INTO NSH_GOODS(
			ITEM_SEQ, ITEM_CODE, GUBUN, COM_SEQ, CARMAKERSEQ, CARMODELSEQ, CARGRADESEQ, PRODUCTNM, CARYYYY, COLOR, GRADE, PART1, PART2, PART3, 
			USER_PRICING_YN, USER_PRICE, SUPPLIER_PRICING_YN, SUPPLIER_PRICE, SEARCH_TAG, CONTS,
			APPROVAL, FEE_YN, STOCK_YN, COMMISSION,
			REG_ID, REG_DT
		)VALUES(
			SEQ_NSH_GOODS.NEXTVAL, 'P' || TO_CHAR(SYSDATE, 'YYMMDD') || to_char(10000000+SEQ_NSH_GOODS.nextval), #{gubun}, ${session_member_com_seq}, #{carmakerseq}, #{carmodelseq}, #{cargradeseq}, #{productnm}, #{caryyyy}, #{color}, #{grade}, #{part1}, #{part2}, #{part3}, 
			#{user_pricing_yn}, #{user_price}, #{supplier_pricing_yn}, #{supplier_price}, #{search_tag}, #{conts},
			'N', 'C', 'Y', 0,
			#{session_member_id}, SYSDATE
		)
	</update>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<sql id="product_listWhere">
		WHERE 1=1
        <if test="!(receiver == null or receiver == '')" >
        	AND a.RECEIVER LIKE '%${receiver}%'
        </if>
        <if test="!(productnm == null or productnm == '')" >
        	AND c.PRODUCTNM LIKE '%${productnm}%'
        </if>
        <if test="!(status == null or status == '')" >
        	AND b.STATUS = #{status} 
        </if>
        <if test="!(orderno == null or orderno == '')" >
        	AND a.ORDERNO LIKE '%${orderno}%' 
        </if>
        <if test="!(paytyp == null or paytyp == '')" >
        	AND a.PAYTYP = #{paytyp} 
        </if>
        <if test="!(session_member_com_seq == null or session_member_com_seq== '')" >
        	AND c.COM_SEQ = #{session_member_com_seq} 
        </if>
        <if test="sdate != null and sdate != '' and edate != null and edate != ''" >
        	AND a.ORDERDATE BETWEEN TO_DATE(#{sdate} || '000000', 'YYYY-MM-DDHH24MISS') AND TO_DATE(#{edate} || '235959', 'YYYY-MM-DDHH24MISS')
        </if>
	</sql>
	
	<select id="product_list" parameterType="Map" resultType="mcmap">
		SELECT PT1.*, IS_LOCATION(CARPARTCODE) AS PART_LOCATION FROM (
			SELECT
			    ROW_NUMBER() OVER(ORDER BY b.CART_NO DESC) RN,
			    a.ORDERNO, a.ORDERDATE, a.RECEIVER,
			    b.CART_NO, b.STATUS, b.AMT,
                (SELECT CODE_NM FROM MC_COMMON_CODE WHERE CODE_GROUP_SEQ = '40' AND b.STATUS=CODE) AS STATUS_NM,
			    c.PRODUCTNM, c.ITEM_SEQ, c.ERP_CODE, c.CARPARTCODE, 
			    d.COM_NM, b.QTY, c.GRADE,
			    (SELECT PARTNM FROM V_IS_CARPART WHERE c.PART3=CARPARTSEQ) AS PART3_NM,
			    ('/upload/board/'||e.YYYY||'/'||e.MM||'/'||e.UUID) AS THUMB
			FROM NSH_ORDERMST a JOIN NSH_CART b
			ON a.ORDERNO=b.ORDERNO
			    AND b.STATUS!='0'
			JOIN NSH_GOODS c
			ON b.ITEM_SEQ = c.ITEM_SEQ
			LEFT OUTER JOIN NSH_COOPERATION d
			ON c.COM_SEQ = d.SEQ
			LEFT OUTER JOIN (
			    SELECT
			        bb.*
			    FROM (SELECT max(uuid) as uuid FROM NSH_ATTACH WHERE TABLE_NM='NSH_GOODS' GROUP BY TABLE_NM, TABLE_SEQ) aa LEFT OUTER JOIN NSH_ATTACH bb
			    ON aa.UUID = bb.UUID
			) e
			ON c.ITEM_SEQ = e.TABLE_SEQ
			<include refid="product_listWhere"/>
		) PT1
		WHERE CEIL(RN/NVL(#{rows},10))=NVL(#{cpage},1)
	</select>
	
	<select id="product_pagination" parameterType="Map" resultType="mcmap">
		SELECT
			CEIL(COUNT(1)/NVL(#{rows}, 10)) TOTALPAGE,
			COUNT(1) TOTALCOUNT
        FROM NSH_ORDERMST a JOIN NSH_CART b
		ON a.ORDERNO=b.ORDERNO
		    AND b.STATUS!='0'
		JOIN NSH_GOODS c
		ON b.ITEM_SEQ = c.ITEM_SEQ
		LEFT OUTER JOIN NSH_COOPERATION d
		ON c.COM_SEQ = d.SEQ
		LEFT OUTER JOIN (
		    SELECT
		        bb.*
		    FROM (SELECT max(uuid) as uuid FROM NSH_ATTACH WHERE TABLE_NM='NSH_GOODS' GROUP BY TABLE_NM, TABLE_SEQ) aa LEFT OUTER JOIN NSH_ATTACH bb
		    ON aa.UUID = bb.UUID
		) e
		ON c.ITEM_SEQ = e.TABLE_SEQ
		<include refid="product_listWhere"/>
	</select>
	
	<select id="all_cooperation" parameterType="Map" resultType="mcmap">
		SELECT SEQ, COM_NM FROM NSH_COOPERATION ORDER BY COM_NM ASC
	</select>
	
	
</mapper>