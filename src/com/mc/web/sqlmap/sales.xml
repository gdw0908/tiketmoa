<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="sales">	
	<select id="list" parameterType="Map" resultType="mcmap">
		SELECT
		     MAX(e.COM_NM) AS COM_NM,
		     MAX(e.seq) AS COM_SEQ,
		     NVL(COUNT(*), 0) AS ORDERCOUNT,
		     NVL(SUM(a.QTY), 0) AS ORDERQTY,
		     NVL(SUM(c.USER_PRICE), 0)  AS BF_DISCOUNT,
		     NVL(SUM(CASE WHEN b.PAYTYP = 'card' THEN c.USER_PRICE END), 0) AS CARD,
		     NVL(SUM(CASE WHEN b.PAYTYP = 'virtual' THEN c.USER_PRICE END), 0) AS VIRTUAL,
		     NVL(SUM(CASE WHEN b.PAYTYP = 'iche' THEN c.USER_PRICE END), 0) AS ICHE,
		     NVL(SUM(c.SALE_PRICE), 0) AS SALE_PRICE
		FROM
		     NSH_CART a, NSH_ORDERMST b , NSH_GOODS c , NSH_COOPERATION_MEMBER d, NSH_COOPERATION e
		WHERE a.ORDERNO = b.ORDERNO  
		AND a.ITEM_SEQ = c.ITEM_SEQ 
		AND c.REG_ID = d.MEMBER_ID
		AND d.PARENT_SEQ = e.SEQ
		AND c.DEL_YN = 'N'
		AND e.DEL_YN = 'N'
		AND a.STATUS > 0
		AND a.PAY_E_DT IS NULL
		AND a.HAN_C_DT IS NULL
		<choose>
		<when test="!(com_nm == null or com_nm == '')">
		AND d.MEMBER_ID = #{com_nm}
		</when>
		<otherwise>
		<if test="!(session_group_seq == 1)">
		AND d.MEMBER_ID = #{session_member_id}
		</if>
		</otherwise>
		</choose>
		
		<if test="!(start_date == null or end_date == '')" >
		AND TO_CHAR(b.ORDERDATE, 'YYYY-MM-DD') BETWEEN #{start_date}
        AND #{end_date}
		</if>
		<if test="!(date == null or date == '')" >
		AND TO_CHAR(b.ORDERDATE, 'YYYY-MM-DD') = #{date}
		</if>
		<if test="!(m_year == null or month == '')" >
		 AND TO_CHAR(b.ORDERDATE, 'YYYY-MM') = #{m_year}||'-'||#{month}
		</if>
		<if test="!(year == null or branch == '')" >
		 AND TO_CHAR(b.ORDERDATE, 'YYYY-MM') BETWEEN #{year}||'-'||#{start_month}
        AND #{year}||'-'||#{end_month}
        </if>
        <if test="!(y_year == null or y_year == '')" >
		AND TO_CHAR(b.ORDERDATE, 'YYYY') = #{y_year}
        </if>
        
		GROUP BY e.COM_NM
		ORDER BY e.COM_NM
	</select>

	<select id="com_list_group" parameterType="Map" resultType="mcmap">
		SELECT 
			B.MEMBER_ID AS MEMBER_ID,
			A.COM_NM AS COM_NM
	    FROM
	    	NSH_COOPERATION A,
	    	NSH_COOPERATION_MEMBER B
	    WHERE
	    	A.SEQ = B.PARENT_SEQ 
	    AND
	    	A.DEL_YN = 'N'
	</select>
</mapper>