<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="popupzone">

	<select id="list" parameterType="Map" resultType="mcmap">
		SELECT PT1.* FROM (
		SELECT 
			T1.POPUPZONE_SEQ, T1.TITLE, T1.LINK_YN, T1.LINK_URL, T1.LINK_TARGET, T1.FILE_PATH,
			T1.USE_YN, T1.ORDER_SEQ, T1.REG_DT, T1.REG_SEQ, T1.REG_NM, T1.MOD_DT, T1.MOD_SEQ, T1.MOD_NM,
			T1.START_DT, T1.END_DT, T1.ALT, T1.RL, T1.MOBILE,
			CASE WHEN T1.REG_DT >= SYSDATE-3 THEN 'Y' ELSE 'N' END NEW_YN,
			ROW_NUMBER() OVER(ORDER BY REG_DT DESC) RN
		FROM NSH_POPUPZONE T1
		LEFT OUTER JOIN (
		SELECT
            C.*
        FROM (
            SELECT
              MEMBER_SEQ, MEMBER_ID, MEMBER_PW, MEMBER_NM, GROUP_SEQ, 
              0 AS COM_SEQ, '' AS COM_NM
            FROM MC_MEMBER
            WHERE DEL_YN='N'
            UNION ALL            
            SELECT
                a.PARENT_SEQ AS MEMBER_SEQ, a.MEMBER_ID, a.MEMBER_PW, b.COM_NM AS MEMBER_NM, 3 AS GROUP_SEQ,
                b.SEQ AS COM_SEQ, b.COM_NM
            FROM NSH_COOPERATION_MEMBER a  JOIN NSH_COOPERATION b
            ON B.DEL_YN='N'
                AND a.PARENT_SEQ = b.SEQ
        ) C) B ON B.MEMBER_SEQ = T1.REG_SEQ 
        WHERE T1.DEL_YN = 'N'
        AND T1.SELECTER in (#{selecter})
        <if test="!(keyword == null or keyword == '')" >
		AND T1.TITLE like '%${keyword}%'
		</if>
		) PT1
		WHERE CEIL(RN/NVL(#{rows, jdbcType=INTEGER},10))=NVL(#{cpage, jdbcType=INTEGER},1)  ORDER BY RN ASC
	</select>
	
	<select id="pageinfo" parameterType="Map" resultType="mcmap">
		SELECT 
		CEIL(COUNT(1)/NVL(#{rows, jdbcType=INTEGER},10)) TOTALPAGE,
		COUNT(1) TOTALCOUNT
		FROM NSH_POPUPZONE T1
		WHERE
		T1.DEL_YN = 'N'
		AND T1.SELECTER in (#{selecter})
		<if test="!(keyword == null or keyword == '')" >
        AND TITLE like '%${keyword}%' 
        </if>
	</select>
	
	<insert id="insert" parameterType="Map">
		INSERT INTO NSH_POPUPZONE(
			  POPUPZONE_SEQ,
			  TITLE,
			  LINK_YN,
			  LINK_URL,
			  LINK_TARGET,
			  FILE_PATH,
			  USE_YN,
			  <if test="!(order_seq == null or order_seq == '')">
			  ORDER_SEQ,
			  </if>
			  REG_SEQ,
			  REG_NM,
			  START_DT,
			  END_DT,
			  ALT,
			  <if test="!(rl == null or rl == '')">
			  RL,
			  </if>
			  SELECTER
			  <if test="!(x_coord == null or x_coord == '')">
			  ,X_COORD
			  </if>
			  <if test="!(y_coord == null or y_coord == '')">
			  ,Y_COORD
			  </if>
			  <if test="!(mobile == null or mobile == '')">
			  ,MOBILE
			  </if>
		)values(
			  SEQ_NSH_POPUPZONE.nextval,
			  #{title},
			  #{link_yn},
			  #{link_url},
			  #{link_target},
			  #{file_path},
			  #{use_yn},
			  <if test="!(order_seq == null or order_seq == '')">
			  #{order_seq},
			  </if>
			  #{session_member_seq},
			  #{session_member_nm},
			  TO_DATE(#{start_dt}, 'YYYY-MM-DD'),
			  TO_DATE(#{end_dt}, 'YYYY-MM-DD'),
			  #{alt},
			  <if test="!(rl == null or rl == '')">
			  #{rl},
			  </if>
			  #{selecter}
			  <if test="!(x_coord == null or x_coord == '')">
			  ,#{x_coord}
			  </if>
			  <if test="!(y_coord == null or y_coord == '')">
			  ,#{y_coord}
			  </if>
			  <if test="!(mobile == null or mobile == '')">
			  ,${mobile}
			  </if>
		)
	</insert>
	
	<select id="view" parameterType="Map" resultType="mcmap">
		SELECT
			POPUPZONE_SEQ,
			TITLE,
			LINK_YN,
			LINK_URL,
			LINK_TARGET,
			FILE_PATH,
			USE_YN,
			ORDER_SEQ,
			TO_CHAR(REG_DT,'YYYY-MM-DD') REG_DT,
			REG_SEQ,
			REG_NM,
			TO_CHAR(START_DT,'YYYY-MM-DD') START_DT,
			TO_CHAR(END_DT,'YYYY-MM-DD') END_DT,
			ALT,
			RL,
			SELECTER,
			X_COORD,
			Y_COORD,
			MOBILE
		FROM NSH_POPUPZONE
		WHERE POPUPZONE_SEQ=#{popupzone_seq}
	</select>
	
	<update id="update" parameterType="Map">
		UPDATE NSH_POPUPZONE SET
		TITLE=#{title},
		LINK_YN=#{link_yn},
		LINK_URL=#{link_url},
		LINK_TARGET=#{link_target},
		FILE_PATH=#{file_path},
		USE_YN=#{use_yn},
		START_DT=TO_DATE(#{start_dt}, 'YYYY-MM-DD'),
		END_DT=TO_DATE(#{end_dt}, 'YYYY-MM-DD'),
		ORDER_SEQ=#{order_seq},
		ALT=#{alt},
		<if test="!(rl == null or rl == '')">
			RL=#{rl},
		</if>
		MOD_DT=SYSDATE, 
		MOD_SEQ=#{session_member_seq}, 
		MOD_NM=#{session_member_nm}
		<if test="!(x_coord == null or x_coord == '')">
		,X_COORD=#{x_coord}
		</if>
		<if test="!(y_coord == null or y_coord == '')">
		,Y_COORD=#{y_coord}
		</if>
		<if test="!(mobile == null or mobile == '')">
		,MOBILE = ${mobile}
		</if>
		WHERE POPUPZONE_SEQ=#{popupzone_seq}
	</update>
	
	<update id="mobile_init" parameterType="Map">
		UPDATE NSH_POPUPZONE SET MOBILE = 0
	</update>
	
	<update id="delete" parameterType="Map">
		UPDATE NSH_POPUPZONE SET DEL_YN='Y', DEL_DT=SYSDATE, DEL_SEQ=#{session_member_seq}, DEL_NM=#{session_member_nm}
		WHERE POPUPZONE_SEQ in (${popupzone_seq})
	</update>   
</mapper>