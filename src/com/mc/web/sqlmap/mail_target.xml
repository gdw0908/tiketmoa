<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mail_target">
	
	<select id="list" parameterType="Map" resultType="mcmap">
		SELECT PT1.* FROM (
			SELECT 
				TG_SEQ, TITLE, TARGET_CD, TG_QUERY_STR, TG_XLS_FILE_NM, TG_INPUT_STR
				, TG_CHK_CD, TG_CNT, ETC, TO_CHAR(REG_DT, 'YYYY/MM/DD') AS REG_DT, REG_NM
				,ROW_NUMBER() OVER(ORDER BY TG_SEQ DESC) AS RN
			FROM NSH_MAILING_TARGET
			WHERE 
				DEL_YN='N'
		<if test="!(keyword == null or keyword == '')" >
			AND ${condition} LIKE '%${keyword}%' 
		</if>
		) PT1
		WHERE CEIL(RN/NVL(#{rows, jdbcType=INTEGER},10))=NVL(#{cpage, jdbcType=INTEGER},1)
	</select>
		
	<select id="pageInfo" parameterType="Map" resultType="mcmap">
		SELECT 
			COUNT(1) AS TOTALCOUNT,
			CEIL(COUNT(1)/NVL(#{rows, jdbcType=INTEGER},10)) AS TOTALPAGE
		FROM 
			NSH_MAILING_TARGET
		WHERE 
			DEL_YN='N'
		<if test="!(keyword == null or keyword == '')" >
		AND ${condition} LIKE '%${keyword}%' 
		</if>
	</select>
	
	<select id="article" parameterType="Map" resultType="mcmap">
		SELECT 
			TG_SEQ, TITLE, TARGET_CD, TG_QUERY_STR, TG_XLS_FILE_NM, TG_INPUT_STR, TG_CHK_CD, TG_CNT, ETC, REG_DT, REG_NM
		FROM 
			NSH_MAILING_TARGET 
		WHERE 
			TG_SEQ = #{tg_seq} 
		AND DEL_YN='N'
	</select>
	
	<select id="targetList" parameterType="Map" resultType="mcmap">
		SELECT EMAIL, NAME FROM NSH_MAILING_TARGET_LIST WHERE TG_SEQ=#{tg_seq}
	</select>
		
	<select id="maxseq" parameterType="Map" resultType="String">
		SELECT SEQ_NSH_MAILING_TARGET.NEXTVAL TG_SEQ FROM DUAL
	</select>
	
	<select id="target_count" parameterType="Map" resultType="String">
		SELECT
            COUNT(1) AS CNT
        FROM (
            SELECT
                MEMBER_NM, EMAIL, GROUP_SEQ
            FROM MC_MEMBER
              WHERE DEL_YN='N'
            UNION ALL            
            SELECT
                B.STAFF_NM AS MEMBER_NM, B.STAFF_EMAIL AS EMAIL, 3 AS GROUP_SEQ
            FROM NSH_COOPERATION B
             WHERE B.DEL_YN='N'
        )
        <if test="tg_chk_cd != '0'.toString()">
		WHERE GROUP_SEQ IN (${tg_chk_cd}) 
		</if>		
	</select>
	
	<select id="mb_info" parameterType="Map" resultType="mcmap">
		SELECT
		  EMAIL, MEMBER_NM, GROUP_SEQ
		FROM(
		  SELECT
		    MEMBER_NM, EMAIL, GROUP_SEQ
		  FROM MC_MEMBER
		    WHERE DEL_YN='N'
		  UNION ALL            
		  SELECT
		    B.STAFF_NM AS MEMBER_NM, B.STAFF_EMAIL AS EMAIL, 3 AS GROUP_SEQ
		  FROM NSH_COOPERATION B
		    WHERE B.DEL_YN='N'
		)
		<if test="tg_chk_cd != '0'.toString()">
		WHERE GROUP_SEQ IN (${tg_chk_cd}) 
		</if>
	</select>
	
	<select id="mb_List" parameterType="Map" resultType="mcmap">
		SELECT
		  SUBSTR(XMLAGG(XMLELEMENT (A,' '||EMAIL,';'||MEMBER_NM)).EXTRACT('//text()'),2) as TARGET_LIST
		FROM(
		  SELECT
		    MEMBER_NM, EMAIL, GROUP_SEQ
		  FROM MC_MEMBER
		    WHERE DEL_YN='N'
		  UNION ALL            
		  SELECT
		    B.STAFF_NM AS MEMBER_NM, B.STAFF_EMAIL AS EMAIL, 3 AS GROUP_SEQ
		  FROM NSH_COOPERATION B
		    WHERE B.DEL_YN='N'
		)
		<if test="tg_chk_cd != '0'.toString()">
		WHERE GROUP_SEQ IN (${tg_chk_cd}) 
		</if>
	</select>
	
	<insert id="regist" parameterType="Map">
		INSERT INTO NSH_MAILING_TARGET(
			TG_SEQ
			, TITLE
			, TARGET_CD
			, TG_QUERY_STR
			, TG_XLS_FILE_NM
			, TG_INPUT_STR
			, TG_CHK_CD
			, TG_CNT
			, ETC
			, REG_SEQ
			, REG_NM
		)VALUES(
		  	#{tg_seq}
		  	, #{title}
		  	, #{target_cd}
		  	, #{tg_query_str}
		  	, #{tg_xls_file_nm}
		  	, #{tg_input_str}
		  	, #{tg_chk_cd}
		  	, #{tg_cnt}
		  	, #{etc}
		  	, #{session_member_seq}
		  	, #{session_member_nm}
		)
	</insert>
	
	<insert id="registTarget" parameterType="Map">
		INSERT INTO NSH_MAILING_TARGET_LIST(  
			TGL_SEQ
			, TG_SEQ
			, NAME
			, EMAIL  
		)VALUES (  
			SEQ_NSH_MAILING_TARGET_LIST.nextval
			, #{tg_seq}
			, #{name}
			, #{email}  
		)
	</insert>
	
	<update id="delete" parameterType="Map">
		UPDATE 
			NSH_MAILING_TARGET 
		SET 
			DEL_YN='Y'
			,DEL_SEQ=#{session_member_seq}
			,DEL_NM=#{session_member_nm}
			,DEL_DT=sysdate
		WHERE 
			TG_SEQ = #{tg_seq}
	</update>
	
	<delete id="deleteTarget" parameterType="Map">
		DELETE FROM NSH_MAILING_TARGET_LIST WHERE TG_SEQ = #{tg_seq}
	</delete>
	
	<update id="modify" parameterType="Map">
		UPDATE 
			NSH_MAILING_TARGET 
		SET
			TITLE = #{title}
			,TARGET_CD = #{target_cd}
			,TG_QUERY_STR = #{tg_query_str}
			,TG_XLS_FILE_NM = #{tg_xls_file_nm}
		<if test="tg_cnt != ''">
			,TG_CNT = #{tg_cnt}
		</if>
			,TG_INPUT_STR = #{tg_input_str}
			,TG_CHK_CD = #{tg_chk_cd}
			,ETC = #{etc}
			,MOD_DT = sysdate
			,MOD_SEQ = #{session_member_seq}
			,MOD_NM = #{session_member_nm}
		WHERE 
			TG_SEQ = #{tg_seq}
	</update>    
</mapper>