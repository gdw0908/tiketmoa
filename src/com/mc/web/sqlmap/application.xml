<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="application">
	
	<select id="totalcount" parameterType="Map" resultType="mcmap">
		SELECT
			COUNT(1)+9000 TOTALCOUNT
        FROM NSH_GOODS a LEFT OUTER JOIN NSH_ATTACH b
            ON b.TABLE_NM='NSH_GOODS' AND a.ITEM_SEQ = b.TABLE_SEQ AND b.ORDER_SEQ=1
            LEFT OUTER JOIN NSH_COOPERATION c
            ON a.COM_SEQ= c.SEQ
            LEFT OUTER JOIN V_IS_CARMAKER d ON a.CARMAKERSEQ=d.CARMAKERSEQ
            LEFT OUTER JOIN V_IS_CARMODEL f ON a.CARMODELSEQ=f.CARMODELSEQ
        WHERE a.DEL_YN='N'
	</select>
	
	<select id="notice" parameterType="Map" resultType="mcmap">
	<![CDATA[
		SELECT 
			PT1.* 
		FROM (
			SELECT 
				TITLE,
        		'http://www.partsmoa.co.kr/mobile/mypage/notice/index.do?mode=view&article_seq='|| ARTICLE_SEQ || '&cpage=1&rows=10&condition=&keyword=&menu=menu2' AS URL,
				ROW_NUMBER() OVER(ORDER BY REG_DT DESC, NOTICE_YN DESC, PARENT_SEQ DESC, REPLY_ORDER ASC) RN
			FROM 
				NSH_ARTICLE T1
			WHERE 
				BOARD_SEQ=1
			AND T1.DEL_YN='N'
			AND NOTICE_YN = 'N'
			ORDER BY RN ASC
		) PT1
		WHERE RN <= 4
	]]> 
	</select>
	
	<select id="top_banner" parameterType="Map" resultType="mcmap">
	<![CDATA[
		SELECT PT1.* FROM (
		SELECT 
			T1.POPUPZONE_SEQ, T1.TITLE, T1.LINK_YN, T1.LINK_URL, T1.LINK_TARGET, 'http://www.partsmoa.co.kr' || T1.FILE_PATH AS FILE_PATH,
			T1.USE_YN, T1.ORDER_SEQ, T1.REG_DT, T1.REG_SEQ, T1.REG_NM, T1.MOD_DT, T1.MOD_SEQ, T1.MOD_NM,
			T1.START_DT, T1.END_DT, T1.ALT, T1.RL,
			ROW_NUMBER() OVER(ORDER BY ORDER_SEQ ASC, POPUPZONE_SEQ) RN
		FROM NSH_POPUPZONE T1
        WHERE T1.DEL_YN = 'N'
        AND T1.USE_YN = 'Y'
        AND T1.SELECTER in (1)
        AND (T1.START_DT <= SYSDATE AND T1.END_DT >= SYSDATE-1)
         
        ) PT1
		WHERE RN <= 4
	]]>
	</select>
	
	<select id="event_banner" parameterType="Map" resultType="mcmap">
	<![CDATA[
		SELECT PT1.* FROM (
		SELECT 
			T1.POPUPZONE_SEQ, T1.TITLE, T1.LINK_YN, T1.LINK_URL, T1.LINK_TARGET, 'http://www.partsmoa.co.kr' || T1.FILE_PATH AS FILE_PATH,
			T1.USE_YN, T1.ORDER_SEQ, T1.REG_DT, T1.REG_SEQ, T1.REG_NM, T1.MOD_DT, T1.MOD_SEQ, T1.MOD_NM,
			T1.START_DT, T1.END_DT, T1.ALT, T1.RL,
			ROW_NUMBER() OVER(ORDER BY ORDER_SEQ ASC, POPUPZONE_SEQ) RN
		FROM NSH_POPUPZONE T1
        WHERE T1.DEL_YN = 'N'
        AND T1.USE_YN = 'Y'
        AND T1.SELECTER in (3)
        AND (T1.START_DT <= SYSDATE AND T1.END_DT >= SYSDATE-1)
         
        ) PT1
		WHERE RN <= 3
	]]>
	</select>
	
	<select id="partlist" parameterType="Map" resultType="mcmap">
	<![CDATA[
		SELECT PT1.*, NVL(IS_LOCATION(CARPARTCODE), LOCATION) AS PART_LOCATION FROM (
			SELECT 
				PT_SUB.*,
                (SELECT CARGRADENM FROM V_IS_CARGRADE WHERE PT_SUB.CARGRADESEQ=CARGRADESEQ) AS CARGRADENM,
                (SELECT CODENM FROM V_IS_CODEMST WHERE PT_SUB.PART1=CODENO) AS PART1_NM,
                (SELECT CODENM FROM V_IS_CODEMST WHERE PT_SUB.PART2=CODENO) AS PART2_NM,
                NVL((SELECT PARTNM FROM V_IS_CARPART WHERE PT_SUB.PART3=CARPARTSEQ),PT_SUB.PRODUCTNM) AS PART3_NM,
                (SELECT CODE_NM FROM MC_COMMON_CODE WHERE CODE_GROUP_SEQ = '37' AND PT_SUB.COLOR=CODE) AS COLOR_NM,
                (SELECT DONG_NM FROM NSH_DONG WHERE PT_SUB.SIDO_CD=SIDO AND PT_SUB.SIGUNGU_CD=SIGUNGU AND DONG='000') as SIGUNGU_NM,
                ('http://partsmoa.co.kr/upload/board/'||PT_SUB.YYYY||'/'||PT_SUB.MM||'/'||PT_SUB.UUID||'_thumb') AS THUMB,
                (SELECT SUBSTR(XMLAGG(XMLELEMENT (A,','||'http://partsmoa.co.kr/upload/board/'||YYYY || '/' || MM || '/' || UUID)).EXTRACT('//text()'),2)	FROM NSH_ATTACH WHERE TABLE_NM='NSH_GOODS' AND TABLE_SEQ=PT_SUB.ITEM_SEQ GROUP BY TABLE_SEQ) ATTACH_INFO,
                'http://partsmoa.co.kr/mobile/goods/view.do?menu=menu' || SUBSTR(PART1,9) || '&seq=' || PT_SUB.ITEM_SEQ AS URL,
                ROW_NUMBER() OVER(ORDER BY PT_SUB.ITEM_SEQ DESC) RN
			FROM(
            SELECT
                a.ITEM_SEQ, a.GUBUN, a.ITEM_CODE, a.COM_SEQ, a.ERP_CODE, a.PRODUCTNM,a.CARYYYY, a.GRADE, NVL(a.USER_PRICE, 0) AS USER_PRICE, a.SUPPLIER_PRICE, a.SALE_PRICE, a.INQUIRY_YN,
                a.FEE_YN, a.BESTYN, a.EVENTYN, a.NEWYN, a.PUBLICYN, a.RECOMMYN, a.SALEYN, a.PLANYN, a.STOCK_NUM,
                a.CARMAKERSEQ, a.CARMODELSEQ, a.CARGRADESEQ, a.PART1, a.PART2, a.PART3, a.COLOR,
                a.REG_DT, g.CODE_NM,
                CASE
                WHEN a.SALE_SDATE <= SYSDATE AND a.SALE_EDATE > SYSDATE-1 THEN a.DISCOUNT_RATE
                ELSE 0
                END AS DISCOUNT_RATE,
                a.DISCOUNT_RATE AS DISCOUNT_RATE2, a.CARPARTCODE, a.PART_MAKER, a.LOCATION, 
                d.MAKERNM, f.CARMODELNM,
                a.APPROVAL, DECODE(a.APPROVAL, 'Y', '승인', '비승인') as APPROVAL_NM,
                b.ATTACH_NM,
                c.COM_NM, c.STAFF_TEL, c.SIDO_CD, c.SIGUNGU_CD,
                b.YYYY, b.MM, b.UUID
            FROM NSH_GOODS a LEFT OUTER JOIN NSH_ATTACH b
            ON b.TABLE_NM='NSH_GOODS' AND a.ITEM_SEQ = b.TABLE_SEQ AND b.ORDER_SEQ=1
            LEFT OUTER JOIN NSH_COOPERATION c
            ON a.COM_SEQ = c.SEQ
            LEFT OUTER JOIN V_IS_CARMAKER d ON a.CARMAKERSEQ=d.CARMAKERSEQ
            LEFT OUTER JOIN V_IS_CARMODEL f ON a.CARMODELSEQ=f.CARMODELSEQ
            LEFT OUTER JOIN MC_COMMON_CODE g ON a.COLOR=g.CODE
        	LEFT OUTER JOIN V_IS_CODEMST X ON a.PART2=X.CODENO
            LEFT OUTER JOIN V_IS_CARPART e ON a.PART3=e.CARPARTSEQ
            WHERE a.DEL_YN='N'
            AND a.GUBUN = '1'
            AND a.STOCK_NUM > 0
            AND a.APPROVAL = 'Y'
            AND b.UUID IS NOT NULL
            AND DECODE(a.INQUIRY_YN, 'Y', 1, nvl(a.USER_PRICE, 0)) > 0
			) PT_SUB
      WHERE ROWNUM <= 10
		) PT1
	]]>
	</select>
	
</mapper>